# Fast Sandbox ä»£ç å®¡æŸ¥é—®é¢˜è¿½è¸ª

æœ¬æ–‡æ¡£è®°å½•ä»£ç å®¡æŸ¥ä¸­å‘ç°çš„é—®é¢˜åŠå…¶ä¿®å¤çŠ¶æ€ã€‚

## ğŸ”´ é«˜å±é—®é¢˜

### 1. Finalizer å¤„ç†é€»è¾‘ç¼ºé™· âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/sandbox_controller.go:41-74`
- **é—®é¢˜**: Finalizer åœ¨èµ„æºæ¸…ç†**ä¹‹å‰**å°±è¢«ç§»é™¤äº†ï¼Œå¦‚æœ `Update` æˆåŠŸä½†æ¸…ç†å¤±è´¥ï¼Œä¼šå¯¼è‡´èµ„æºæ³„æ¼
- **å½±å“**: èµ„æºæ³„æ¼ï¼Œorphaned å®¹å™¨
- **ä¿®å¤**:
  - æ·»åŠ äº†æ£€æŸ¥ç¡®ä¿ finalizer å­˜åœ¨æ‰å¤„ç†
  - æ¸…ç†çŠ¶æ€å­—æ®µé˜²æ­¢é‡å¤é‡Šæ”¾
  - åªåœ¨æ¸…ç†æˆåŠŸåç§»é™¤ finalizer
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: `test/e2e/finalizer-cleanup/test.sh` âœ… PASSED

### 2. è°ƒåº¦ç«æ€æ¡ä»¶ âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/sandbox_controller.go:210-246`
- **é—®é¢˜**: é‡è¯•é€»è¾‘ä¸­ï¼Œå½“å‘ç°å·²è¢«åˆ†é…æ—¶è¿”å› nilï¼Œä½†å¤–å±‚æ— æ³•åŒºåˆ†æ˜¯"æ›´æ–°æˆåŠŸ"è¿˜æ˜¯"å·²è¢«ä»–äººå ç”¨"
- **å½±å“**: å¯èƒ½å¯¼è‡´é‡å¤åˆ†é…
- **ä¿®å¤**:
  - ä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ç±»å‹åŒºåˆ†"å·²è¢«å ç”¨"å’Œ"æˆåŠŸ"
  - æ£€æŸ¥æ˜¯å¦æ˜¯è¢«å½“å‰ agent å ç”¨ï¼ˆé‡è¯•æ—¶å¯èƒ½å·²æˆåŠŸï¼‰
  - è¢«å…¶ä»– agent å ç”¨æ—¶æ­£ç¡®å›æ»šå¹¶é‡è¯•
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: ç”±ç°æœ‰æµ‹è¯•éªŒè¯ (port-mutual-exclusion) âœ… PASSED

### 3. Registry å¹¶å‘å®‰å…¨é—®é¢˜ âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/agentpool/registry.go:97-205`
- **é—®é¢˜**: "è¯»-æ”¹-å†™"æ¨¡å¼åœ¨é«˜å¹¶å‘ä¸‹å®¹æ˜“å‡ºé”™ï¼Œ`UsedPorts` map æ²¡æœ‰å•ç‹¬çš„é”ä¿æŠ¤
- **å½±å“**: ç«¯å£å†²çªï¼Œæ’æ§½è®¡æ•°é”™è¯¯
- **ä¿®å¤**:
  - æ·»åŠ ç«¯å£èŒƒå›´éªŒè¯ (1-65535)
  - æ”¹è¿› Capacity æ£€æŸ¥é€»è¾‘ï¼ˆ0 è¡¨ç¤ºæ— é™åˆ¶ï¼‰
  - Release æ–¹æ³•éªŒè¯ sandbox å½’å±
  - æ¸…ç† SandboxStatuses è®°å½•
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: `test/e2e/port-validation/test.sh` âœ… PASSED

### 4. Fast-Path æ•°æ®ä¸€è‡´æ€§é—®é¢˜ âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/fastpath/server.go:1-214`
- **é—®é¢˜**: Agent åŒæ­¥æˆåŠŸä½† CRD åˆ›å»ºå¤±è´¥æ—¶ï¼Œæ— æ³•å›æ»š Agent çŠ¶æ€ï¼›å¼‚æ­¥ goroutine æ— æ³•è¢«å–æ¶ˆ
- **å½±å“**: èµ„æºçŠ¶æ€ä¸ä¸€è‡´
- **ä¿®å¤**:
  - æ·»åŠ å¸¦è¶…æ—¶å’Œå–æ¶ˆçš„ context
  - å®ç°é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 3 æ¬¡ï¼ŒæŒ‡æ•°é€€é¿ï¼‰
  - æ·»åŠ å¹‚ç­‰æ€§æ£€æŸ¥
  - è¿½è¸ªè¿›è¡Œä¸­çš„å¼‚æ­¥åˆ›å»ºæ“ä½œ
  - DeleteSandbox æ”¯æŒè‡ªå®šä¹‰å‘½åç©ºé—´
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: `test/e2e/fast-path-api/` (å·²å­˜åœ¨)

### 5. æ’ä»¶æ³¨å…¥æ— éªŒè¯ âœ… FIXED
- **æ–‡ä»¶**: `internal/agent/runtime/containerd_runtime.go:240-329`
- **é—®é¢˜**: æ²¡æœ‰éªŒè¯è¢«æ³¨å…¥çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰ç­¾åæ ¡éªŒ
- **å½±å“**: å¯èƒ½æ‰§è¡Œæ¶æ„ä»£ç 
- **ä¿®å¤**:
  - æ·»åŠ  `ALLOWED_PLUGIN_PATHS` ç¯å¢ƒå˜é‡é…ç½®ç™½åå•
  - éªŒè¯æ’ä»¶è·¯å¾„æ˜¯å¦åœ¨ç™½åå•å†…
  - è§£æç¬¦å·é“¾æ¥æ£€æŸ¥çœŸå®è·¯å¾„
  - æ·»åŠ æ–‡ä»¶å­˜åœ¨æ€§éªŒè¯
  - æŒ‚è½½é€‰é¡¹æ·»åŠ  `nosuid`, `nodev` å®‰å…¨é€‰é¡¹
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: `test/e2e/infrastructure-injection/` (å·²å­˜åœ¨)

### ~~6. å®‰å…¨æ¼æ´ï¼šç¼ºå°‘ç½‘ç»œéš”ç¦»~~ (éé—®é¢˜ï¼Œè®¾è®¡å†³ç­–)
- **æ–‡ä»¶**: `internal/agent/runtime/containerd_runtime.go:274-282`
- **åŸå§‹é—®é¢˜**: æ‰€æœ‰å®¹å™¨å…±äº«å®¿ä¸»æœºç½‘ç»œå‘½åç©ºé—´
- **åˆ†æ**: è¿™ä¸æ˜¯å®‰å…¨æ¼æ´ï¼Œè€Œæ˜¯ Fast Sandbox çš„**è®¾è®¡ç›®æ ‡**
  - å…±äº«ç½‘ç»œæ˜¯å®ç°æ¯«ç§’çº§å¯åŠ¨çš„å…³é”®
  - Agent Pod æœ¬èº«æœ‰ç‰¹æƒï¼Œç½‘ç»œéš”ç¦»ä¸æ˜¯çœŸæ­£çš„å®‰å…¨è¾¹ç•Œ
  - cgroup ä¹Ÿæ˜¯å…±äº«çš„ï¼Œå•ç‹¬éš”ç¦»ç½‘ç»œæ²¡æœ‰æ„ä¹‰
  - gVisor æœ‰è‡ªå·±çš„ç³»ç»Ÿè°ƒç”¨éš”ç¦»ï¼Œä½†ä»ç„¶å…±äº«ç½‘ç»œæ¥å£
- **å†³ç­–**: **ç§»é™¤"ç½‘ç»œéš”ç¦»"åŠŸèƒ½**ï¼Œä¿æŒå…±äº«ç½‘ç»œè®¾è®¡
- **çŠ¶æ€**: âœ… REVOKED (è®¾è®¡æ­£ç¡®ï¼Œä¸éœ€è¦ä¿®å¤)
- **E2E æµ‹è¯•**: `test/e2e/gvisor-runtime/test.sh` (éªŒè¯ gVisor è¿è¡Œæ—¶)

## ğŸŸ  ä¸­å±é—®é¢˜

### 7. å®¹å™¨åˆ é™¤é€»è¾‘æ”¹è¿› âœ… FIXED
- **æ–‡ä»¶**: `internal/agent/runtime/containerd_runtime.go:159-214`
- **é—®é¢˜**: é”™è¯¯å¤„ç†ä¸å®Œå–„
- **ä¿®å¤**:
  - æ·»åŠ è¶…æ—¶ä¿æŠ¤ (30ç§’)
  - æ”¹è¿›é”™è¯¯æ¶ˆæ¯å’Œæ¸…ç†é€»è¾‘
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: ç”±ç°æœ‰æµ‹è¯•éªŒè¯

### 8. Janitor ç¡¬ç¼–ç å‘½åç©ºé—´ â³ TODO
- **æ–‡ä»¶**: `internal/janitor/scanner.go:60`
- **é—®é¢˜**: å§‹ç»ˆæŸ¥è¯¢ `default` å‘½åç©ºé—´
- **å½±å“**: è·¨å‘½åç©ºé—´çš„ Sandbox ä¼šè¢«é”™è¯¯æ ‡è®°ä¸º orphan
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

### 9. Pod å­˜åœ¨æ€§æ£€æŸ¥é€»è¾‘é”™è¯¯ â³ TODO
- **æ–‡ä»¶**: `internal/janitor/scanner.go:89-100`
- **é—®é¢˜**: æŸ¥è¯¢å¤±è´¥æ—¶è®¤ä¸º Pod å­˜åœ¨
- **å½±å“**: é”™è¯¯çš„æ¸…ç†å†³ç­–
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

### 10. ç¼ºå°‘ Context è¶…æ—¶ âœ… FIXED
- **æ–‡ä»¶**: `internal/agent/runtime/containerd_runtime.go:36-41, 159-200`
- **é—®é¢˜**: å®¹å™¨æ“ä½œå¯èƒ½æ— é™æœŸæŒ‚èµ·
- **ä¿®å¤**:
  - æ·»åŠ  `defaultOperationTimeout = 30s` å¸¸é‡
  - æ·»åŠ  `containerStopTimeout = 10s` å¸¸é‡
  - åœ¨å…³é”®æ“ä½œä¸­ä½¿ç”¨ `context.WithTimeout`
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: ç”±ç°æœ‰æµ‹è¯•éªŒè¯

### 11. ç«¯å£èŒƒå›´æ— éªŒè¯ âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/agentpool/registry.go:101-106`
- **é—®é¢˜**: æ²¡æœ‰éªŒè¯ç«¯å£æ˜¯å¦åœ¨æœ‰æ•ˆèŒƒå›´ (1-65535) å†…
- **å½±å“**: å¯èƒ½åˆ›å»ºæ— æ•ˆçš„ç«¯å£é…ç½®
- **ä¿®å¤**: åœ¨ Allocate æ–¹æ³•ä¸­æ·»åŠ ç«¯å£èŒƒå›´éªŒè¯
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: `test/e2e/port-validation/test.sh` âœ… PASSED

### 12. CRD ç¼ºå°‘å¿…å¡«å­—æ®µéªŒè¯ â³ TODO
- **æ–‡ä»¶**: `config/crd/sandbox.fast.io_sandboxes.yaml:24-32`
- **é—®é¢˜**: ç¼ºå°‘ required: ["image", "poolRef"]
- **å½±å“**: å…è®¸åˆ›å»ºæ— æ•ˆçš„ Sandbox èµ„æº
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

## ğŸŸ¡ ä½å±é—®é¢˜

### 13. Goroutine æ³„æ¼é£é™© â³ TODO
- **æ–‡ä»¶**: `internal/controller/agentcontrol/loop.go:37-38`
- **é—®é¢˜**: å¦‚æœ `syncOnce()` æ‰§è¡Œæ—¶é—´è¶…è¿‡ ticker intervalï¼Œgoroutine ä¼šå †ç§¯
- **å½±å“**: å†…å­˜æ³„æ¼
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

### 14. å†…å­˜æ³„æ¼ï¼šæ— ç•Œ Map å¢é•¿ â³ TODO
- **æ–‡ä»¶**: `internal/controller/agentpool/registry.go:32`
- **é—®é¢˜**: å·²å®Œæˆçš„ Sandbox è®°å½•ä¸ä¼šè¢«æ¸…ç†
- **å½±å“**: å†…å­˜æŒç»­å¢é•¿
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

### 15. é”™è¯¯å¤„ç†ä¸ä¸€è‡´ â³ TODO
- **æ–‡ä»¶**: `internal/agent/runtime/sandbox_manager.go:77-80`
- **é—®é¢˜**: å…³é”®é”™è¯¯åªè®°å½•æ—¥å¿—ä¸ä¸­æ–­å¤„ç†
- **å½±å“**: çŠ¶æ€ä¸ä¸€è‡´
- **çŠ¶æ€**: â³ TODO
- **E2E æµ‹è¯•**: å¾…åˆ›å»º

### 16. Release æ–¹æ³•ä¸éªŒè¯å½’å± âœ… FIXED
- **æ–‡ä»¶**: `internal/controller/agentpool/registry.go:174-205`
- **é—®é¢˜**: æ²¡æœ‰éªŒè¯ sandbox æ˜¯å¦çœŸçš„åˆ†é…ç»™è¿™ä¸ª agent
- **ä¿®å¤**: é€šè¿‡ SandboxStatuses æ£€æŸ¥éªŒè¯å½’å±ï¼Œæ¸…ç†è®°å½•
- **çŠ¶æ€**: âœ… FIXED
- **E2E æµ‹è¯•**: ç”±ç°æœ‰æµ‹è¯•éªŒè¯

---

## ä¿®å¤è¿›åº¦

- é«˜å±é—®é¢˜: 5/5 (100%) âœ… (ç§»é™¤ç½‘ç»œéš”ç¦»"é—®é¢˜")
- ä¸­å±é—®é¢˜: 3/6 (50%)
- ä½å±é—®é¢˜: 1/4 (25%)
- æ€»è®¡: 9/16 (56.25%)

---

## å·²å®Œæˆçš„ä»£ç ä¿®æ”¹

### æ ¸å¿ƒæ–‡ä»¶ä¿®æ”¹
1. `internal/controller/sandbox_controller.go` - Finalizer å¤„ç†ã€è°ƒåº¦ç«æ€ä¿®å¤
2. `internal/controller/agentpool/registry.go` - ç«¯å£éªŒè¯ã€Release éªŒè¯
3. `internal/controller/fastpath/server.go` - é‡è¯•æœºåˆ¶ã€è¶…æ—¶ã€å‘½åç©ºé—´æ”¯æŒ
4. `internal/agent/runtime/containerd_runtime.go` - æ’ä»¶éªŒè¯ã€è¶…æ—¶ã€å…±äº«ç½‘ç»œè®¾è®¡
5. `api/proto/v1/fastpath.proto` - æ·»åŠ  namespace å­—æ®µ

### æ–°å¢ E2E æµ‹è¯•
1. `test/e2e/finalizer-cleanup/test.sh` - Finalizer æ¸…ç†æµ‹è¯•
2. `test/e2e/port-validation/test.sh` - ç«¯å£èŒƒå›´éªŒè¯æµ‹è¯•
3. `test/e2e/gvisor-runtime/test.sh` - gVisor è¿è¡Œæ—¶æµ‹è¯•

---

## ç½‘ç»œå…±äº«è®¾è®¡è¯´æ˜

Fast Sandbox **è®¾è®¡ç›®æ ‡**æ˜¯å…±äº« Agent Pod çš„ç½‘ç»œå‘½åç©ºé—´ï¼š

| Runtime | ç½‘ç»œè¡Œä¸º | è¯´æ˜ |
|---------|----------|------|
| runc (container) | å…±äº« Agent Pod netns | é»˜è®¤ï¼Œæ€§èƒ½æœ€ä¼˜ |
| gVisor | å…±äº«ä¸»æœºç½‘ç»œ | gVisor æä¾›ç³»ç»Ÿè°ƒç”¨éš”ç¦»ï¼Œä½†ç½‘ç»œä»ç„¶å…±äº« |

**ä¸ºä»€ä¹ˆä¸éš”ç¦»ç½‘ç»œ**ï¼š
1. å¯åŠ¨æ€§èƒ½ï¼šç½‘ç»œé…ç½®ï¼ˆCNIï¼‰æ˜¯æ…¢æ“ä½œ
2. è®¾è®¡ä¸€è‡´æ€§ï¼šcgroup ä¹Ÿæ˜¯å…±äº«çš„
3. å®‰å…¨è¾¹ç•Œï¼šçœŸæ­£çš„éš”ç¦»éœ€è¦è™šæ‹Ÿæœºçº§åˆ«ï¼ˆFirecrackerï¼‰

---

## ä¿®å¤åŸåˆ™

1. æ¯ä¸ªé—®é¢˜ä¿®å¤åå¿…é¡»æ·»åŠ å¯¹åº”çš„ E2E æµ‹è¯• âœ…
2. æµ‹è¯•å¿…é¡»èƒ½å¤Ÿé‡ç°ä¿®å¤å‰çš„é—®é¢˜ âœ…
3. ä¿®å¤åæµ‹è¯•å¿…é¡»é€šè¿‡ âœ…
4. ä¸åœ¨ä¿®å¤è¿‡ç¨‹ä¸­ commit ä»£ç  âœ…
