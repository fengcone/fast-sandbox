syntax = "proto3";

package fastpath.v1;

option go_package = "fast-sandbox/api/proto/v1;fastpathv1";

service FastPathService {
  // CreateSandbox 极速创建沙箱，绕过 K8s 控制面延迟
  rpc CreateSandbox(CreateRequest) returns (CreateResponse);

  // DeleteSandbox 极速删除沙箱
  rpc DeleteSandbox(DeleteRequest) returns (DeleteResponse);

  // UpdateSandbox 更新沙箱配置（过期时间、重启、策略等）
  rpc UpdateSandbox(UpdateRequest) returns (UpdateResponse);

  // ListSandboxes 获取沙箱列表
  rpc ListSandboxes(ListRequest) returns (ListResponse);

  // GetSandbox 获取沙箱详情
  rpc GetSandbox(GetRequest) returns (SandboxInfo);
}

// ... (保持现有消息定义不变)

message ListRequest {
  string namespace = 1;
}

message ListResponse {
  repeated SandboxInfo items = 1;
}

message GetRequest {
  string sandbox_name = 1;  // CRD name (user-provided)
  string namespace = 2;     // optional, default "default"
}

message SandboxInfo {
  string sandbox_id = 1;    // container ID (md5 hash or UID)
  string sandbox_name = 8;   // CRD name (user-provided)
  string phase = 2;
  string agent_pod = 3;
  repeated string endpoints = 4;
  int64 created_at = 5;
  string image = 6;
  string pool_ref = 7;
}


// ConsistencyMode 定义创建 sandbox 的一致性模式
enum ConsistencyMode {
  // FAST 模式：先创建 Agent，后写 CRD（默认）
  // 最低延迟，但 CRD 写入失败可能导致正在使用的 sandbox 被清理
  FAST = 0;

  // STRONG 模式：先写 CRD，后创建 Agent
  // 延迟略高，但保证强一致性
  STRONG = 1;
}

message CreateRequest {
  string image = 1;
  string pool_ref = 2;
  repeated int32 exposed_ports = 3;
  repeated string command = 4;
  repeated string args = 5;
  string namespace = 6; // 可选，默认为 "default"
  ConsistencyMode consistency_mode = 7; // 可选，默认使用 Controller 配置
  string name = 8; // 可选，指定沙箱名称（用于测试故障注入）
  map<string, string> envs = 9; // 环境变量
  string working_dir = 10; // 工作目录
}

message CreateResponse {
  string sandbox_id = 1;      // container ID (md5 hash or UID)
  string sandbox_name = 4;    // CRD name (user-provided)
  string agent_pod = 2;
  repeated string endpoints = 3; // IP:Port 列表
}

message DeleteRequest {
  string sandbox_name = 1;    // CRD name (user-provided)
  string namespace = 2; // 可选，默认为 "default"
}

message DeleteResponse {
  bool success = 1;
}

// FailurePolicy 定义故障恢复策略
enum FailurePolicy {
  MANUAL = 0;        // 仅报告状态，不自动恢复
  AUTO_RECREATE = 1; // 自动重新调度
}

message UpdateRequest {
  string sandbox_name = 1;  // CRD name (user-provided)
  string namespace = 2;

  // 可更新字段 (only one at a time, except labels)
  oneof update {
    int64 expire_time_seconds = 3;     // Unix timestamp, 0 = remove expiry
    string reset_revision = 4;         // ISO8601 timestamp, 触发重启
    FailurePolicy failure_policy = 5;  // 更新故障策略
    int32 recovery_timeout_seconds = 6;
  }

  // 标签更新 (可以与其他字段同时更新)
  map<string, string> labels = 7;
}

message UpdateResponse {
  bool success = 1;
  string message = 2;
  SandboxInfo sandbox = 3;  // 更新后的状态
}
