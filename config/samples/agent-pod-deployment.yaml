apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-sandbox-agent
  namespace: default
  labels:
    app: sandbox-agent
spec:
  replicas: 1  # 对应 poolMin: 1
  selector:
    matchLabels:
      app: sandbox-agent
  strategy:
    type: Recreate  # 使用 Recreate 策略避免多个特权 Pod 同时运行
  template:
    metadata:
      labels:
        app: sandbox-agent
    spec:
      serviceAccountName: default
      # 需要访问宿主机的 containerd socket 和 cgroup
      hostPID: true
      containers:
        - name: agent
          image: reg.docker.alibaba-inc.com/sandbox-k8s/fast-agent:0.1.1
          imagePullPolicy: IfNotPresent
          # 需要特权模式以创建容器和管理 cgroup/netns
          securityContext:
            privileged: true
          env:
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            - name: POD_IP
              valueFrom:
                fieldRef:
                  fieldPath: status.podIP
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: RUNTIME_TYPE
              value: "containerd"
            - name: RUNTIME_SOCKET
              value: "/run/containerd/containerd.sock"
          ports:
            - name: agent-http
              containerPort: 8081
              protocol: TCP
            - name: dlv-debug
              containerPort: 2345
              protocol: TCP
          volumeMounts:
            - name: containerd-sock
              mountPath: /run/containerd/containerd.sock
            - name: cgroup
              mountPath: /sys/fs/cgroup
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 500m
              memory: 512Mi
      volumes:
        - name: containerd-sock
          hostPath:
            path: /run/containerd/containerd.sock
            type: Socket
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup
            type: Directory
      restartPolicy: Always
      tolerations:
        - effect: NoSchedule
          key: sigma.ali/is-ecs
          operator: Exists
        - effect: NoSchedule
          key: sigma.ali/resource-pool
          value: ackee_pool